#!/usr/bin/env node

require('source-map-support/register')
const { assertSanHTMLEqual } = require('../dist/index')
const { execFileSync } = require('child_process')
const chalk = require('chalk')
const { readFileSync, readdirSync } = require('fs')
const { join } = require('path')
const { caseRoot, jsExists, tsExists, compileJS, compileTS } = require('../dist/fixtures/case')

const caseName = process.argv[2]
if (!caseName) {
    console.error('Usage: debug <CASE_NAME>')
    console.error('Example: debug array-literal')
    console.error()
    console.error('Available case names:')
    console.error(readdirSync(caseRoot).map(x => `  - ${x}`).join('\n'))
    process.exit(1)
}

const htmlPath = join(caseRoot, caseName, 'expected.html')
const expected = readFileSync(htmlPath, 'utf8')
console.log(chalk.cyan(`[EXPECT] ${caseName}`), expected)

if (jsExists(caseName)) debugCompileJSToSource()
if (tsExists(caseName)) debugCompileTSToSource()
if (jsExists(caseName)) debugCompileToRenderer()

function debugCompileJSToSource () {
    compileJS(caseName)
    const got = execFileSync(join(__dirname, `./render-by-source.js`), [caseName], { encoding: 'utf8' }).toString()
    try {
        assertSanHTMLEqual(got, expected)
        console.log(chalk.green(`[SRC JS] ${caseName}`), got)
    } catch (err) {
        console.log(chalk.red(`[SRC JS] ${caseName}`), got)
    }
}

function debugCompileTSToSource () {
    compileTS(caseName)
    const got = execFileSync(join(__dirname, `./render-by-source.js`), [caseName], { encoding: 'utf8' }).toString()
    try {
        assertSanHTMLEqual(got, expected)
        console.log(chalk.green(`[SRC TS] ${caseName}`), got)
    } catch (err) {
        console.log(chalk.red(`[SRC TS] ${caseName}`), got)
    }
}

function debugCompileToRenderer () {
    const got = execFileSync(join(__dirname, `./render-onthefly.js`), [caseName], { encoding: 'utf8' }).toString()
    try {
        assertSanHTMLEqual(got, expected)
        console.log(chalk.green(`[RENDER] ${caseName}`), got)
    } catch (err) {
        console.log(chalk.red(`[RENDER] ${caseName}`), got)
    }
}
